import React, { useState, useEffect, createContext, useContext } from "react";
import { BrowserRouter as Router, Routes, Route, Link, useNavigate } from "react-router-dom";

// --------- Auth Context ---------
const AuthContext = createContext();
export const useAuth = () => useContext(AuthContext);

function AuthProvider({ children }) {
  const [user, setUser] = useState(() => JSON.parse(localStorage.getItem("kairah_user")) || null);

  useEffect(() => {
    if (user) localStorage.setItem("kairah_user", JSON.stringify(user));
    else localStorage.removeItem("kairah_user");
  }, [user]);

  const signIn = (email, name) => {
    const u = { email, name: name || email.split("@")[0], isPaid: false, plan: null, freeVideosLeft: 1, favorites: [] };
    setUser(u);
    return u;
  };

  const signOut = () => setUser(null);
  const upgrade = (plan) => setUser(prev => ({ ...prev, isPaid: true, plan }));
  const decrementFree = () => setUser(prev => ({ ...prev, freeVideosLeft: Math.max(0, (prev.freeVideosLeft || 1) - 1) }));
  const addFavorite = (template) => setUser(prev => ({ ...prev, favorites: Array.from(new Set([...(prev.favorites || []), template])) }));

  return (
    <AuthContext.Provider value={{ user, signIn, signOut, upgrade, decrementFree, addFavorite }}>
      {children}
    </AuthContext.Provider>
  );
}

// --------- Utils ---------
const copyText = async (t) => {
  try { await navigator.clipboard.writeText(t); alert(`Copied: ${t}`); } 
  catch { alert("Copy failed"); }
};

// --------- Templates ---------
const TEMPLATES = [
  { name:"Talking Monkey", category:"Animal", isPaid:true, captions:["Look at this talking monkey! üêí"], hashtags:["monkey","funny"] },
  { name:"Cute Kitten", category:"Animal", isPaid:false, captions:["Adorable kitten vibes üê±"], hashtags:["kitten","cute"] },
  { name:"ASMR Glass Cutting", category:"ASMR", isPaid:true, captions:["Relaxing ASMR sounds ‚ú®"], hashtags:["asmr","relax"] },
  { name:"Modern Love Story", category:"Romance", isPaid:true, captions:["Romantic AI cinematic scene üíñ"], hashtags:["love","romance"] },
  { name:"Epic Action Scene", category:"Action", isPaid:true, captions:["Thrilling moment!"], hashtags:["action","movie"] },
];

// --------- Header ---------
function Header() {
  const { user, signOut } = useAuth();
  return (
    <header style={{ padding:"1rem", borderBottom:"1px solid #ccc", marginBottom:"1rem" }}>
      <Link to="/">Kairah Studio</Link> | <Link to="/studio">Studio</Link> | <Link to="/pricing">Pricing</Link> | 
      {user ? <span> {user.name} <button onClick={signOut}>Logout</button></span> : <Link to="/signin">Login</Link>}
    </header>
  );
}

// --------- Landing ---------
function Landing() {
  return (
    <div>
      <h1>Kairah Studio + Fame Booster</h1>
      <p>Generate stunning AI videos for animals, ASMR, stories, cinematic clips, music, and more.</p>
      <Link to="/studio"><button>Try Studio</button></Link>
    </div>
  );
}

// --------- SignIn ---------
function SignIn() {
  const { signIn } = useAuth();
  const navigate = useNavigate();
  const [email, setEmail] = useState("");
  const [name, setName] = useState("");

  const submit = e => {
    e.preventDefault();
    if (!email) return alert("Enter email");
    signIn(email, name);
    navigate("/studio");
  };

  return (
    <div>
      <h2>Sign in to Kairah Studio</h2>
      <form onSubmit={submit}>
        <input value={email} onChange={e => setEmail(e.target.value)} placeholder="Email" />
        <input value={name} onChange={e => setName(e.target.value)} placeholder="Display name (optional)" />
        <button type="submit">Sign in</button>
      </form>
    </div>
  );
}

// --------- Studio ---------
function Studio() {
  const { user, decrementFree } = useAuth();
  const [prompt, setPrompt] = useState("");
  const [selected, setSelected] = useState(null);
  const [myVideos, setMyVideos] = useState(() => JSON.parse(localStorage.getItem("kairah_my_videos") || "[]"));
  const [playingVideo, setPlayingVideo] = useState(null);

  const promptMagic = () => {
    if(!prompt) return alert("Enter prompt");
    setPrompt("Viral-enhanced: " + prompt + " üöÄ");
  };

  const handleGenerate = () => {
    if(!user) return alert("Sign in first");
    if(!selected) return alert("Select template");
    if(!user.isPaid && (user.freeVideosLeft||0)<=0) return alert("Free video limit reached");

    const newVideo = { id: Date.now(), template: selected.name, status: "ready", createdAt: new Date().toISOString() };
    const updated = [newVideo, ...myVideos];
    setMyVideos(updated);
    localStorage.setItem("kairah_my_videos", JSON.stringify(updated));
    if(!user.isPaid) decrementFree();

    setPlayingVideo(newVideo.id);
    setTimeout(() => setPlayingVideo(null), 6000);
    alert("Video generated (mock). Preview will play for 6 seconds.");
  };

  return (
    <div>
      <h2>Kairah Studio</h2>
      <input value={prompt} onChange={e => setPrompt(e.target.value)} placeholder="Type your idea..." />
      <button onClick={promptMagic}>Prompt Magic</button>
      <button onClick={handleGenerate}>Generate Video</button>

      <h3>Templates</h3>
      {TEMPLATES.map(t => (
        <div key={t.name} style={{ border:"1px solid #ccc", margin:"0.5rem", padding:"0.5rem" }}>
          <strong>{t.name}</strong> ({t.category}) {t.isPaid && !user?.isPaid ? " [LOCKED]" : ""}
          <div>
            <button onClick={() => { if(t.isPaid&&!user?.isPaid) return alert("Upgrade to access"); setSelected(t); }}>Select</button>
          </div>
          <div>
            {t.captions.map(c => <span key={c} onClick={() => copyText(c)} style={{ margin:"0.2rem", cursor:"pointer" }}>{c}</span>)}
          </div>
          <div>
            {t.hashtags.map(h => <span key={h} onClick={() => copyText(h)} style={{ margin:"0.2rem", cursor:"pointer" }}>#{h}</span>)}
          </div>
        </div>
      ))}

      {playingVideo && (
        <div>
          üé¨ Playing {myVideos.find(v=>v.id===playingVideo)?.template} (mock 6s preview)
        </div>
      )}

      <h3>My Videos</h3>
      {myVideos.length === 0 ? <p>No videos yet.</p> :
        myVideos.map(v => <div key={v.id}>{v.template} - {v.status}</div>)
      }
    </div>
  );
}

// --------- Pricing ---------
function Pricing() {
  return (
    <div>
      <h2>Pricing</h2>
      <p>Free: 1 video</p>
      <p>Pro: Unlimited videos</p>
      <p>Diamond: Unlimited + premium templates</p>
    </div>
  );
}

// --------- App ---------
export default function App() {
  return (
    <AuthProvider>
      <Router>
        <Header />
        <Routes>
          <Route path="/" element={<Landing />} />
          <Route path="/signin" element={<SignIn />} />
          <Route path="/studio" element={<Studio />} />
          <Route path="/pricing" element={<Pricing />} />
        </Routes>
      </Router>
    </AuthProvider>
  );
}
