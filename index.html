import React, { useState, useEffect, createContext, useContext } from "react";
import { BrowserRouter as Router, Routes, Route, Navigate, Link, useNavigate } from "react-router-dom";
import { initializeApp } from "firebase/app";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "firebase/auth";

// ---------------- Firebase Setup ----------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// ---------------- Auth Context ----------------
const AuthContext = createContext();
const useAuth = () => useContext(AuthContext);

const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [plan, setPlan] = useState("free");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser?.email.includes("pro")) setPlan("pro");
      else if (currentUser?.email.includes("diamond")) setPlan("diamond");
      else setPlan("free");
      setLoading(false);
    });
    return unsubscribe;
  }, []);

  return (
    <AuthContext.Provider value={{ user, plan }}>
      {!loading && children}
    </AuthContext.Provider>
  );
};

// ---------------- Protected Route ----------------
const ProtectedRoute = ({ children }) => {
  const { user } = useAuth();
  return user ? children : <Navigate to="/signin" />;
};

// ---------------- Landing Page ----------------
const LandingPage = () => (
  <div className="p-10">
    <head>
      <title>Kairah Studio - AI Video Generator</title>
      <meta name="description" content="Preview Kairah Studio features. Sign in to generate AI videos." />
    </head>
    <h1 className="text-4xl font-bold mb-4">Welcome to Kairah Studio</h1>
    <p className="mb-4">Explore AI-generated videos, prompts, and templates. Sign in to start creating your own videos.</p>
    <Link to="/signin" className="bg-blue-500 text-white p-2 rounded">Sign In</Link>
    <div className="mt-8 p-4 border rounded shadow animate-pulse">
      <h2 className="font-semibold mb-2">Feature Preview:</h2>
      <ul className="list-disc ml-6">
        <li>6-second high-quality AI video generation (Free)</li>
        <li>Viral video prompts & categories</li>
        <li>Pro/Diamond unlimited access</li>
        <li>Prompt Magic button to enhance prompts</li>
        <li>Download simulation and video history</li>
      </ul>
    </div>
  </div>
);

// ---------------- SignIn Page ----------------
const SignInPage = () => {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [isSignUp, setIsSignUp] = useState(false);
  const navigate = useNavigate();

  const handleAuth = async (e) => {
    e.preventDefault();
    try {
      if (isSignUp) {
        await createUserWithEmailAndPassword(auth, email, password);
      } else {
        await signInWithEmailAndPassword(auth, email, password);
      }
      navigate("/generate");
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <div className="p-10 max-w-md mx-auto">
      <h2 className="text-2xl mb-4">{isSignUp ? "Sign Up" : "Sign In"}</h2>
      <form onSubmit={handleAuth} className="flex flex-col gap-4">
        <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="p-2 border rounded"/>
        <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="p-2 border rounded"/>
        {error && <p className="text-red-500">{error}</p>}
        <button type="submit" className="bg-blue-500 text-white p-2 rounded">{isSignUp ? "Sign Up" : "Sign In"}</button>
      </form>
      <p className="mt-4">
        {isSignUp ? "Already have an account?" : "Don't have an account?"}{" "}
        <span className="text-blue-500 cursor-pointer" onClick={() => setIsSignUp(!isSignUp)}>
          {isSignUp ? "Sign In" : "Sign Up"}
        </span>
      </p>
    </div>
  );
};

// ---------------- Video Generator Page ----------------
const VideoGenerator = () => {
  const { plan } = useAuth();
  const [generated, setGenerated] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState("viral");
  const [prompt, setPrompt] = useState("Funny cat dancing");
  const [history, setHistory] = useState([]);

  const defaultPrompts = {
    viral: ["Funny cat dancing", "Epic fail moment", "Dance challenge"],
    royal: ["Queen portrait animation", "Royal crown reveal"],
    fantasy: ["Dragon flying", "Magic forest scene"]
  };

  useEffect(() => {
    const email = auth.currentUser?.email;
    const savedHistory = JSON.parse(localStorage.getItem(`history_${email}`)) || [];
    setHistory(savedHistory);
    setPrompt(defaultPrompts[selectedCategory][0]);
  }, [selectedCategory]);

  const handleGenerateVideo = () => {
    const email = auth.currentUser.email;
    if (plan === "free") {
      const videosUsed = localStorage.getItem(`videos_${email}`) || 0;
      if (videosUsed >= 1) {
        alert("Free plan allows only 1 video. Upgrade for more.");
        return;
      }
      localStorage.setItem(`videos_${email}`, Number(videosUsed) + 1);
    }
    setGenerated(true);
    const newHistory = [...history, prompt];
    setHistory(newHistory);
    localStorage.setItem(`history_${email}`, JSON.stringify(newHistory));
  };

  const handlePromptMagic = () => {
    const enhanced = `${prompt} ðŸ”¥âœ¨ (Enhanced Prompt Magic!)`;
    setPrompt(enhanced);
  };

  return (
    <div className="p-10 max-w-xl mx-auto">
      <h2 className="text-3xl mb-4">Video Generator</h2>
      <div className="mb-4">
        <label className="font-semibold mr-2">Category:</label>
        <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="p-2 border rounded">
          {Object.keys(defaultPrompts).map(cat => <option key={cat} value={cat}>{cat}</option>)}
        </select>
      </div>

      <div className="mb-4 flex gap-2">
        <input type="text" value={prompt} onChange={e => setPrompt(e.target.value)} className="p-2 border rounded w-full"/>
        <button onClick={handlePromptMagic} className="bg-yellow-500 text-white p-2 rounded">Prompt Magic</button>
      </div>

      <button onClick={handleGenerateVideo} className="bg-green-500 text-white p-2 rounded">Generate Video</button>

      {generated && (
        <div className="mt-4 p-4 border rounded bg-gray-100">
          ðŸŽ¬ Your 6-second video is ready! 
          <button className="ml-2 text-blue-500 underline">Download</button>
        </div>
      )}

      <div className="mt-6">
        <h3 className="font-semibold mb-2">Generated Video History:</h3>
        {history.length === 0 ? (
          <p className="text-gray-500">No videos generated yet.</p>
        ) : (
          <ul className="list-disc ml-6">
            {history.map((item, idx) => <li key={idx}>{item}</li>)}
          </ul>
        )}
      </div>

      <p className="mt-4 text-sm">Plan: {plan}</p>
    </div>
  );
};

// ---------------- App Component ----------------
export default function App() {
  return (
    <AuthProvider>
      <Router>
        <Routes>
          <Route path="/" element={<LandingPage />} />
          <Route path="/signin" element={<SignInPage />} />
          <Route path="/generate" element={
            <ProtectedRoute>
              <VideoGenerator />
            </ProtectedRoute>
          } />
        </Routes>
      </Router>
    </AuthProvider>
  );
}
